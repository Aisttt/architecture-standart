### **Название задачи:** Передача ставок по депозитам в кол-центр для банка "Стандарт"
### **Автор:** Команда цифровой трансформации банка "Стандарт"
### **Дата:** 04.08.2024

**Контекст:** Дополнение к [MVP архитектуре депозитов](../Task3/deposits-mvp-adr.md) для обеспечения консультирования через кол-центры.

### **Функциональные требования**
Use Cases для передачи ставок в кол-центр:

|**№**|**Действующие лица или системы**|**Use Case**|**Описание**|
| :-: | :- | :- | :- |
|UC1|Система ставок → Внутренний кол-центр|Предоставление актуальных ставок операторам|1. Система получает обновлённые ставки из АБС<br/>2. Обрабатывает и форматирует данные<br/>3. Обновляет ставки в системе кол-центра<br/>4. Операторы видят актуальную информацию в интерфейсе<br/>5. При звонке клиента оператор консультирует по текущим ставкам|
|UC2|Система ставок → Партнёрский кол-центр|Передача ставок через SFTP файлы|1. Система генерирует файл с актуальными ставками<br/>2. Форматирует данные согласно требованиям партнёра<br/>3. Загружает файл на SFTP сервер партнёра<br/>4. Партнёр получает уведомление о новом файле<br/>5. Операторы партнёра используют данные для консультаций|
|UC3|Сотрудник бэк-офиса → Excel → Система ставок|Обновление ставок через Excel процесс|1. Сотрудники кредитного отдела рассчитывают ставки в Excel<br/>2. Отправляют файл в отдел депозитов по email<br/>3. Отдел депозитов обновляет ставки в системе<br/>4. Система автоматически распространяет обновления<br/>5. Все каналы получают актуальные ставки|
|UC4|Клиент → Оператор кол-центра → Система|Консультирование клиента по депозитам|1. Клиент звонит в кол-центр с вопросом о депозитах<br/>2. Оператор вводит данные клиента в систему<br/>3. Система показывает доступные ставки для клиента<br/>4. Оператор консультирует по условиям<br/>5. При необходимости создаёт заявку в системе|
|UC5|Система мониторинга → Администратор|Отслеживание синхронизации ставок|1. Система отслеживает время последнего обновления ставок<br/>2. При задержке отправляет уведомление администратору<br/>3. Логирует все операции передачи данных<br/>4. Предоставляет метрики успешности синхронизации|

### **Нефункциональные требования**
Требования для системы передачи ставок:

|**№**|**Требование**|
| :-: | :- |
|NFR1|**Актуальность данных**: Ставки должны обновляться в кол-центрах не позднее чем через 30 минут после изменения в АБС|
|NFR2|**Надёжность передачи**: SLA 99.5% успешной доставки ставок в кол-центры|
|NFR3|**Безопасность**: Шифрование данных при передаче через SFTP, авторизация доступа к ставкам|
|NFR4|**Производительность**: Обработка и передача ставок должна занимать не более 5 минут|
|NFR5|**Мониторинг**: Логирование всех операций передачи данных, алерты при сбоях|
|NFR6|**Совместимость**: Формат файлов для партнёра должен быть CSV/JSON/XML по их требованиям|
|NFR7|**Масштабируемость**: Возможность подключения дополнительных партнёрских кол-центров|
|NFR8|**Rollback**: Возможность отката к предыдущей версии ставок при обнаружении ошибок|

### **Решение**
Предлагается создание централизованного сервиса управления ставками с интеграциями для всех каналов обслуживания.

#### Диаграммы архитектуры
**C4 диаграммы:**
- [`context-diagram.puml`](context-diagram.puml) - Диаграмма контекста для передачи ставок (PlantUML)
  - [context-diagram-rates.svg](context-diagram-rates.svg) - SVG версия для просмотра
- [`containers-diagram.puml`](containers-diagram.puml) - Диаграмма контейнеров для передачи ставок (PlantUML)
  - [containers-diagram-rates.svg](containers-diagram-rates.svg) - SVG версия для просмотра

#### Ключевые архитектурные решения:

**1. Централизованный Rates Management Service**
- Единая точка управления ставками по депозитам
- Интеграция с существующим Excel процессом
- API для внутренних систем
- SFTP экспорт для внешних партнёров

**2. Интеграция с существующим процессом**
- Email Gateway для получения Excel файлов от сотрудников
- Автоматический парсинг Excel файлов со ставками
- Валидация данных перед обновлением
- Версионирование изменений ставок

**3. Dual-channel distribution**
- **Internal Channel**: REST API для системы кол-центра банка
- **External Channel**: SFTP file export для партнёрских кол-центров
- Различные форматы данных для разных получателей

**4. Monitoring & Alerting**
- Real-time мониторинг синхронизации ставок
- Alerting при сбоях в передаче данных
- Dashboard для отслеживания актуальности данных
- Audit log всех изменений ставок

#### Технологическое решение:

**Rates Management Service:**
- Platform: Spring Boot (Java) для совместимости с кол-центром
- Database: PostgreSQL для хранения ставок и истории изменений
- Cache: Redis для быстрого доступа к актуальным ставкам
- Scheduler: Quartz для периодических задач синхронизации

**Интеграционные адаптеры:**
- Email Integration: Java Mail API для получения Excel файлов
- Excel Parser: Apache POI для обработки Excel файлов
- SFTP Client: JSch для загрузки файлов партнёрам
- ABS Integration: JDBC/REST для синхронизации с АБС

**Форматы данных:**
- Внутренний API: JSON REST
- Партнёрские файлы: CSV/XML (настраиваемо)
- Логирование: JSON structured logs

### **Альтернативы**

1. **Прямая интеграция с системой кол-центра**
   - Модификация существующей системы кол-центра для получения ставок из АБС
   - Плюсы: Меньше промежуточных компонентов
   - Минусы: Нагрузка на АБС, сложность интеграции с партнёрами

2. **Расширение Excel процесса**
   - Автоматическая рассылка Excel файлов в кол-центры
   - Плюсы: Минимальные изменения в текущем процессе
   - Минусы: Ручная обработка, высокий риск ошибок, нет real-time обновлений

3. **Message-based архитектура**
   - Использование Kafka для распространения событий об изменении ставок
   - Плюсы: Высокая масштабируемость, eventual consistency
   - Минусы: Сложность для партнёров, требует экспертизы в event-driven архитектуре

**Недостатки, ограничения, риски**

**Недостатки выбранного решения:**
1. **Дублирование данных** - ставки хранятся в нескольких местах (кэш, кол-центр, файлы)
2. **Latency** - обновления доходят до операторов с задержкой (до 30 минут)
3. **Complexity** - добавляется новый сервис, требующий поддержки
4. **Single point of failure** - если Rates Service недоступен, обновления останавливаются

**Ограничения:**
1. **Excel dependency** - сохраняется зависимость от ручного процесса расчёта ставок
2. **SFTP limitations** - партнёр получает только batch updates, нет real-time данных
3. **Format constraints** - ограничены форматами, которые может принять партнёр
4. **Email reliability** - зависимость от email для получения Excel файлов

**Риски:**
1. **Риск рассинхронизации** - данные в разных системах могут временно не совпадать
2. **Риск безопасности** - передача чувствительных данных через SFTP и email
3. **Риск производительности** - большие Excel файлы могут замедлить обработку
4. **Риск человеческой ошибки** - неправильные данные в Excel приведут к неверным ставкам во всех каналах
5. **Риск доступности партнёра** - недоступность SFTP сервера партнёра остановит передачу данных

**Способы митигации рисков:**
- **Валидация данных** на всех этапах обработки
- **Checksums и digital signatures** для проверки целостности файлов
- **Retry mechanisms** для обработки временных сбоев
- **Fallback mechanisms** - если новые ставки недоступны, используются последние успешно загруженные
- **Comprehensive monitoring** с alerting при любых отклонениях
- **Regular testing** процедур disaster recovery
- **Data reconciliation** - периодическая сверка данных между системами

**План поэтапного внедрения:**
1. **Phase 1**: Создание Rates Management Service с Excel интеграцией
2. **Phase 2**: Интеграция с внутренним кол-центром через API
3. **Phase 3**: Настройка SFTP экспорта для партнёрского кол-центра
4. **Phase 4**: Monitoring, alerting и оптимизация производительности
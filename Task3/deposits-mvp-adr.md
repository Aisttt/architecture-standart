### **Название задачи:** Архитектура MVP онлайн депозитов для банка "Стандарт"

**Контекст:** Решение основано на анализе [IT-ландшафта банка](../Task1/README.md) и [FURPS+ требованиях](../Task2/FURPS+_requirements.md).

### **Функциональные требования**
Верхнеуровневые Use Cases для MVP системы онлайн депозитов:

|**№**|**Действующие лица или системы**|**Use Case**|**Описание**|
| :-: | :- | :- | :- |
|UC1|Новый клиент → Сайт → Менеджер кол-центра|Подача заявки на депозит через сайт|1. Клиент заходит на сайт банка<br/>2. Просматривает список доступных депозитов с актуальными ставками<br/>3. Заполняет заявку (ФИО, телефон, тип депозита)<br/>4. Система сохраняет заявку<br/>5. Менеджер кол-центра получает уведомление<br/>6. Менеджер звонит клиенту для консультации<br/>7. Менеджер может предложить особые условия|
|UC2|Существующий клиент → Интернет-банк → Бэк-офис|Подача заявки в интернет-банке|1. Клиент авторизуется в интернет-банке<br/>2. Переходит в раздел депозитов<br/>3. Видит персонализированные ставки<br/>4. Выбирает счёт и указывает сумму депозита<br/>5. Подтверждает операцию СМС-кодом<br/>6. Система создаёт заявку<br/>7. Заявка попадает в очередь для бэк-офиса|
|UC3|Менеджер бэк-офиса → АБС → Клиент|Обработка заявки на депозит|1. Менеджер получает заявку в АБС<br/>2. Проверяет данные клиента<br/>3. Рассчитывает ставку (используя Excel)<br/>4. Подтверждает условия депозита в АБС<br/>5. АБС отправляет СМС клиенту о подтверждении ставки<br/>6. При согласии клиента открывает депозит<br/>7. АБС отправляет СМС об открытии депозита|
|UC4|Система → Клиент|Уведомления о статусе заявки|1. Система отслеживает изменения статуса заявки<br/>2. При изменении статуса формирует уведомление<br/>3. Отправляет СМС через шлюз<br/>4. Логирует отправку уведомления|
|UC5|Система → Система|Синхронизация данных о ставках|1. Система получает актуальные ставки из АБС<br/>2. Кэширует данные для быстрого доступа<br/>3. Обновляет отображение на сайте и в интернет-банке<br/>4. Уведомляет кол-центр об изменениях|

### **Нефункциональные требования**
Ключевые архитектурно-значимые требования из [FURPS+ анализа](../Task2/FURPS+_requirements.md) (58 детализированных требований):

|**№**|**Требование**|
| :-: | :- |
|NFR1|**Производительность**: Отклик UI < 200мс, справочные данные < 1 сек, до 1000 одновременных заявок|
|NFR2|**Доступность**: SLA 99.9%, работа 24/7, MTTR ≤ 1 мин для автопереключения|
|NFR3|**Масштабируемость**: Горизонтальное масштабирование, распределение нагрузки между серверами и ЦОД|
|NFR4|**Безопасность**: HTTPS/TLS, СМС-аутентификация, 152-ФЗ, аудит ПДн|
|NFR5|**Интеграция**: Избежать прямых API к АБС, асинхронные очереди, REST/SOAP интерфейсы|
|NFR6|**Совместимость**: MS SQL, Oracle, .NET, Java, существующие платформы банка|
|NFR7|**Удобство**: Дизайн-система банка, WCAG 2.1 AA, мобильность, русская локализация|
|NFR8|**Поддерживаемость**: CI/CD, blue-green deployment, централизованное логирование, API документация|

### **Решение**
Предлагается микросервисная архитектура с асинхронной обработкой заявок для минимизации нагрузки на АБС.

#### Диаграммы архитектуры
**C4 диаграммы:**
- [`context-diagram.puml`](context-diagram.puml) - Диаграмма контекста C4
  - [context-diagram.svg](context-diagram.svg) - SVG версия для просмотра
- [`containers-diagram.puml`](containers-diagram.puml) - Диаграмма контейнеров C4  
  - [containers-diagram.svg](containers-diagram.svg) - SVG версия для просмотра

#### Ключевые архитектурные решения:

**1. Микросервисная архитектура для новых компонентов**
- Deposits Service - управление заявками на депозиты
- Notification Service - отправка уведомлений
- Rates Service - управление ставками и кэширование
- API Gateway - централизованная точка входа

**2. Асинхронная обработка через очереди сообщений**
- Использование Apache Kafka для обмена сообщениями между сервисами
- Заявки из интернет-банка и сайта попадают в очередь
- Бэк-офис обрабатывает заявки из очереди в удобном темпе
- Уведомления отправляются асинхронно

**3. Кэширование данных о ставках**
- Redis кэш для быстрого доступа к актуальным ставкам
- Синхронизация с АБС через периодические задания
- Персонализированные ставки рассчитываются на лету

**4. API-first подход**
- REST API для всех взаимодействий между компонентами
- OpenAPI спецификации для документирования
- Версионирование API для обратной совместимости

**5. Горизонтальное масштабирование**
- Контейнеризация сервисов (Docker)
- Load Balancer для распределения нагрузки
- Auto-scaling по метрикам нагрузки

**6. Интеграция с существующими системами**
- АБС интеграция через периодическую синхронизацию (избегая прямых вызовов)
- СМС-шлюз через HTTP API
- Кол-центр получает уведомления через webhook

#### Технологический стек:
- **API Gateway**: Nginx + Kong/Zuul
- **Микросервисы**: Spring Boot (Java) для совместимости с кол-центром
- **Очереди**: Apache Kafka
- **Кэш**: Redis
- **БД**: PostgreSQL для новых сервисов, интеграция с Oracle АБС
- **Мониторинг**: ELK Stack (Elasticsearch, Logstash, Kibana)
- **Контейнеризация**: Docker + Kubernetes

### **Альтернативы**
1. **Монолитное расширение интернет-банка**
   - Добавление функций депозитов в существующий ASP.NET MVC
   - Проще в реализации, но не решает проблему производительности
   - Увеличивает нагрузку на АБС через прямые подключения

2. **Синхронная интеграция с АБС**
   - Создание REST API для АБС
   - Более быстрая обработка заявок
   - Но может перегрузить АБС и создать единую точку отказа

3. **Использование ESB (Enterprise Service Bus)**
   - Централизованная интеграционная шина
   - Хорошо для больших enterprise систем
   - Но добавляет сложность и может стать узким местом

**Недостатки, ограничения, риски**

**Недостатки выбранного решения:**
1. **Сложность архитектуры** - микросервисы требуют более сложного управления и мониторинга
2. **Eventual Consistency** - асинхронная обработка может привести к временной несогласованности данных
3. **Network latency** - взаимодействие между сервисами через сеть добавляет задержки
4. **Операционная сложность** - требуется экспертиза в DevOps и контейнеризации

**Ограничения (из FURPS+ +R1-+R14):**
1. **Нельзя модифицировать ядро интернет-банка без подрядчика** (+R3)
2. **Избежать прямых API вызовов к АБС** - БД уже перегружена (+R2)
3. **АБС масштабируется только вертикально** - ограничение Oracle БД (+R5)
4. **Kafka несовместим с текущим интернет-банком** (+R4)
5. **Обязательная личная идентификация новых клиентов** - банковское законодательство (+R6)
6. **Разделение доступов между отделами** - требования безопасности (+R7)
7. **Соответствие 152-ФЗ и аудит ПДн** - российское законодательство (+R11, +R12)
8. **Обмен ставками только через CSV/Excel по SFTP** - текущий процесс (+R14)

**Риски:**
1. **Риск производительности** - неправильная настройка кэширования может привести к устаревшим данным
2. **Риск безопасности** - увеличение количества интеграций расширяет поверхность атак
3. **Риск доступности** - отказ Kafka может нарушить обработку заявок
4. **Риск данных** - потеря сообщений в очереди может привести к потере заявок
5. **Риск интеграции** - проблемы с синхронизацией между новыми сервисами и АБС

**Способы митигации рисков:**
- Мониторинг всех компонентов и SLA метрик
- Резервирование критических компонентов (Kafka cluster, Redis cluster)
- Регулярное тестирование disaster recovery процедур
- Постепенное внедрение с canary deployments
- Comprehensive logging и tracing для быстрого выявления проблем